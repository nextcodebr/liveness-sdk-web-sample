var Liveness;(()=>{"use strict";var e={648:e=>{e.exports=class{constructor(e,t){t.height=Math.floor(.7778*t.width),this.config=t,this.token=t.token,this.videoWrapper=e,this.faceapi=null,this.faceapiPath=t.faceapiPath,this.isShowPreview=t.isShowPreview,this.errorCallback=t.errorCallback,this.successCallback=t.successCallback,this.livenessUrlBase=t.livenessUrlBase,this.displaySize={width:t.width,height:t.height},this.livenessConfirmEndpoint=t.livenessConfirmEndpoint||"/liveness/v2"}async start(){window.faceapi?(this.faceapi=window.faceapi,this.setLiveness()):await this.loadFaceApi()}setLiveness(){this.setLoading(),this.createModalConfirmationWrapper().createModalConfirmation().createVideoElement().startVideo()}resetLiveness(){this.removeCanvas(),this.resetVideoWrapper(),this.closePreviewModal(),this.base64="",this.removeLoading(),this.setLiveness()}async loadFaceApi(){const e=document.createElement("script"),t=`${this.faceapiPath}/face-api.min.js`;return e.src=t,document.head.append(e),e.onload=async()=>{await this.loadFaceApiModels()},this}async loadFaceApiModels(){return setTimeout((async()=>{await faceapi.nets.tinyFaceDetector.loadFromUri(this.faceapiPath),await faceapi.nets.faceLandmark68Net.loadFromUri(this.faceapiPath),await faceapi.nets.faceRecognitionNet.loadFromUri(this.faceapiPath),await faceapi.nets.faceExpressionNet.loadFromUri(this.faceapiPath),this.faceapi=faceapi,this.setLiveness()}),1e3),this}startVideo(){return setTimeout((()=>{navigator.mediaDevices.getUserMedia({video:{}}).then((e=>{this.video.srcObject=e})).catch((e=>console.error(e)))}),100),this}createVideoElement(){return this.video=document.createElement("video"),this.video.style.width=this.config.width,this.video.style.height=this.config.height,this.video.style.transform="scaleX(-1)",this.video.setAttribute("muted",!0),this.video.setAttribute("autoplay",!0),this.videoWrapper.style.position="relative",this.videoWrapper.style.width=this.config.width,this.videoWrapper.style.height=this.config.height,this.videoWrapper.append(this.video),this.setVideoMask(),this.video.addEventListener("play",(()=>{this.createMessageBox(),this.loop()})),this}resetVideoWrapper(){const e=document.getElementById("video-wrapper");e&&(e.innerHTML="")}removeCanvas(){const e=document.getElementsByTagName("canvas")[0];e&&e.remove()}setVideoMask(){this.videoWrapper.insertAdjacentHTML("beforeend",this.createMask()),this.maskEllipse=document.getElementById("mask-ellipse"),this.svgMask=document.getElementById("svg-mask"),this.svgMask.style.width=this.config.width,this.svgMask.style.height=this.config.height}createMask(){return'<svg\n    id="svg-mask"\n    style="display: none;"\n    viewBox="0 0 720 560"\n    fill="none"\n    xmlns="http://www.w3.org/2000/svg"\n  >\n    <path\n      id="mask-ellipse"\n      d="M507.5 275C507.5 332.25 490.842 383.977 464.035 421.328C437.225 458.683 400.41 481.5 360 481.5C319.59 481.5 282.775 458.683 255.965 421.328C229.158 383.977 212.5 332.25 212.5 275C212.5 217.75 229.158 166.023 255.965 128.672C282.775 91.3174 319.59 68.5 360 68.5C400.41 68.5 437.225 91.3174 464.035 128.672C490.842 166.023 507.5 217.75 507.5 275Z"\n      stroke="#B40000"\n      stroke-width="5"\n    />\n    <path\n      fill-rule="evenodd"\n      clip-rule="evenodd"\n      d="M21 10C15.4772 10 11 14.4772 11 20V542C11 547.523 15.4771 552 21 552H698C703.523 552 708 547.523 708 542V20C708 14.4772 703.523 10 698 10H21ZM360 481C441.186 481 507 388.771 507 275C507 161.229 441.186 69 360 69C278.814 69 213 161.229 213 275C213 388.771 278.814 481 360 481Z"\n      fill="#000"\n      fill-opacity="0.6"\n    />\n    <rect\n      x="12.5"\n      y="12.5"\n      width="695"\n      height="535"\n      stroke="white"\n      stroke-width="25"\n    />\n  </svg>'}loop(){this.video.style.width.includes("%")&&(this.displaySize.width=this.video.clientWidth,this.video.style.width=this.video.clientWidth);const e=this.faceapi.createCanvasFromMedia(this.video);e.style.position="absolute",e.style.left=0,e.style.top=8,e.style.width=this.videoWrapper.style.width,e.style.height=this.videoWrapper.style.height,this.videoWrapper.append(e),this.faceapi.matchDimensions(e,this.displaySize),this.svgMask.setAttribute("style","display: block; position:absolute; top: 0; left: 0;"),this.maskEllipse.setAttribute("style","display: block;");const t={width:Math.floor(.515*this.config.width),height:Math.floor(.922*this.config.height)};t.left=Math.floor(e.width/1.95-t.width/1.95),t.top=Math.floor((e.height-t.height)/2.25);const i={width:Math.floor(.8*t.width),height:Math.floor(t.height/5)};i.left=Math.floor(t.left+t.width/1.95-i.width/1.95),i.top=Math.floor(t.top+.4*t.height);const s={width:Math.floor(.68*t.width),height:Math.floor(t.height/5)};s.left=Math.floor(t.left+t.width/1.96-s.width/1.96),s.top=Math.floor(t.top+.4*t.height);const n=e.getContext("2d");n.translate(e.width,0),n.scale(-1,1),this.config.isDebug&&this.draw(n,e,t,s,i);const o=e.getBoundingClientRect(),a={counter:0,inProgress:!1,done:!1},r=setInterval((async()=>{if(a.inProgress||a.done)return;a.inProgress=!0;const h=await this.faceapi.detectSingleFace(this.video,new this.faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceExpressions();if(this.removeLoading(),!h)return this.blockMask("Face não encontrada",o,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);const d=this.faceapi.resizeResults(h,this.displaySize);if(d&&d.expressions){const e=this.getExpression(d.expressions);if("neutral"!==e)return this.config.isDebug?this.blockMask(`Mantenha expressão neutra >> ${e}`,o,t.left,t.top,t.height,t.width):this.blockMask("Mantenha expressão neutra",o,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1)}if(d.detection){const h=this.getPose(d);if("front"!==h)return this.config.isDebug?this.blockMask(`Centralize seu rosto >> ${h}`,o,t.left,t.top,t.height,t.width):this.blockMask("Centralize seu rosto",o,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);const l=d.landmarks.getJawOutline();if(this.isRotatedFace(l[0],l[16]))return this.config.isDebug?this.blockMask("Centralize seu rosto >> rotacionado",o,t.left,t.top,t.height,t.width):this.blockMask("Centralize seu rosto",o,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);this.config.isDebug&&(this.draw(n,e,t,s,i),n.beginPath(),n.lineWidth="5",n.strokeStyle="green",n.moveTo(l[0].x,l[0].y),n.lineTo(l[16].x,l[16].y),n.stroke());const c={meanPosition:[l[0].x,l[0].y],frameBox:{isInside:!1},outterBox:{isInside:!1},innerBox:{isInside:!1}},p={meanPosition:[l[16].x,l[16].y],frameBox:{isInside:!1},outterBox:{isInside:!1},innerBox:{isInside:!1}};if(c.frameBox.isInside=this.isInside(c.meanPosition,{top:t.top,left:t.left,width:t.width,height:t.height}),p.frameBox.isInside=this.isInside(p.meanPosition,{top:t.top,left:t.left,width:t.width,height:t.height}),c.outterBox.isInside=this.isInside(c.meanPosition,{top:i.top,left:i.left,width:i.width,height:i.height}),p.outterBox.isInside=this.isInside(p.meanPosition,{top:i.top,left:i.left,width:i.width,height:i.height}),c.innerBox.isInside=this.isInside(c.meanPosition,{top:s.top,left:s.left,width:s.width,height:s.height}),p.innerBox.isInside=this.isInside(p.meanPosition,{top:s.top,left:s.left,width:s.width,height:s.height}),!c.frameBox.isInside||!p.frameBox.isInside)return this.blockMask("Posicione seu rosto dentro da moldura",o,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(!c.outterBox.isInside||!p.outterBox.isInside)return this.blockMask("Afaste seu rosto",o,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(c.innerBox.isInside||p.innerBox.isInside)return this.blockMask("Aproxime seu rosto",o,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);this.msg.style="display: none;",this.activateEllipseMask(),a.counter+=1,a.inProgress=!1,a.counter>=2&&(a.done=!0,this.takePicture(e),clearInterval(r))}}),250)}activateEllipseMask(){this.maskEllipse.setAttribute("stroke","#0F0")}deactivateEllipseMask(){this.maskEllipse.setAttribute("stroke","#F00")}draw(e,t,i,s,n){e.clearRect(0,0,t.width,t.height),e.beginPath(),e.lineWidth="3",e.strokeStyle="blue",e.rect(i.left,i.top,i.width,i.height),e.stroke(),e.beginPath(),e.lineWidth="2",e.strokeStyle="yellow",e.rect(s.left,s.top,s.width,s.height),e.stroke(),e.beginPath(),e.lineWidth="2",e.strokeStyle="red",e.rect(n.left,n.top,n.width,n.height),e.stroke()}getExpression(e){const t=[];for(const[i,s]of Object.entries(e))t.push({expression:i,confidence:s});const i=t.sort(((e,t)=>e.confidence-t.confidence)).pop();return i&&i.expression?i.expression:null}getPose(e){const t=this.getMeanPosition(e.landmarks.getRightEye()),i=this.getMeanPosition(e.landmarks.getLeftEye()),s=this.getMeanPosition(e.landmarks.getNose()),n=this.getMeanPosition(e.landmarks.getMouth()),o=(this.getTop(e.landmarks.getJawOutline())-n[1])/e.detection.box.height+.5,a=(i[0]+(t[0]-i[0])/2-s[0])/e.detection.box.width;let r="undetected";return e.detection.score>.3&&(r="front",o>.2?r="top":o<-.1?r="bottom":(a<-.04&&(r="left"),a>.04&&(r="right"))),r}isRotatedFace(e,t){return Math.abs(180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI)>7}getMeanPosition(e){return e.map((e=>[e.x,e.y])).reduce(((e,t)=>[e[0]+t[0],e[1]+t[1]])).map((t=>t/e.length))}getTop(e){return e.map((e=>e.y)).reduce(((e,t)=>Math.min(e,t)))}isInside(e=[],t={}){return!(e[1]<t.top||e[0]<t.left||e[1]>t.top+t.height||e[0]>t.left+t.width)}blockMask(e,t,i,s,n,o){const a={width:230,height:35};a.top=s+n+20,a.left=i+o/2-a.width/2,this.maskEllipse.setAttribute("stroke","#B40000"),this.msg.textContent=e,this.msg.style=`\n      padding: 10px;\n      color: #ba3939;\n      position: absolute;\n      text-align: center;\n      background: #ffe0e0;\n      top: ${a.top}px;\n      left: ${a.left}px;\n      width: ${a.width}px; \n      height: ${a.height}px;\n      border: 1px solid #a33a3a;\n      font-family: 'Prompt', sans-serif;\n    `}takePicture(e){const t=e.getContext("2d");e.style="display: none;",t.drawImage(this.video,0,0,e.width,e.height),this.base64=e.toDataURL("image/png"),this.isShowPreview?this.openPreviewModal():this.confirmPicture()}createMessageBox(){return this.msg=document.createElement("div"),this.videoWrapper.append(this.msg),this}createModalConfirmationWrapper(){return this.modalWrapper=document.createElement("div"),this.modalWrapper.style="\n    top: 0;\n    left: 0;\n    z-index: 10;\n    width: 100%;\n    height: 100%;\n    display: none;\n    position: fixed;\n    align-items: center;\n    justify-content: center;\n    background: rgba(20, 20, 20, 0.95);\n    ",this.modalWrapper.id="modalWrapper",document.body.append(this.modalWrapper),this}createModalConfirmation(){this.modalConfirmation=document.createElement("div"),this.modalConfirmation.style="\n    padding: 7px;\n    display: flex;\n    max-width: 720px;\n    background: white;\n    max-height: 560px;\n    border-radius: 7px;\n    position: relative;\n    align-items: center;\n    justify-content: center;\n    ";const e=document.createElement("button");e.textContent="Confirmar",e.style="\n    color: #555;\n    right: 10px;\n    width: 160px;\n    height: 50px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const t=document.createElement("button");t.textContent="Cancelar",t.style="\n    color: #444;\n    right: 10px;\n    width: 160px;\n    height: 50px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const i=document.createElement("div");return i.style="\n    right: 0;\n    bottom: 0;\n    width: 100%;\n    display: flex;\n    padding: 10px 0;\n    position: absolute;\n    justify-content: center;\n    ",i.append(t),i.append(e),this.modalConfirmation.append(i),this.modalWrapper.append(this.modalConfirmation),e.addEventListener("click",(()=>{this.closePreviewModal(),this.confirmPicture()})),t.addEventListener("click",(()=>{this.cancelPicture()})),this}openPreviewModal(){const e=document.createElement("img");e.src=this.base64,e.style="\n      max-width: 720px;\n      min-width: 520px;\n      min-height: 360px;\n      max-height: 560px;\n      object-fit: cover;\n      border-radius: 7px;\n    ",this.modalConfirmation.append(e),this.modalWrapper.style.display="flex"}closePreviewModal(){const e=document.getElementById("modalWrapper");e&&e.remove()}cancelPicture(){this.resetLiveness()}setLoading(){this.videoWrapper.insertAdjacentHTML("beforeend",'<div id="spinner">\n        <div class="lds-ripple">\n          <div style="color: white"></div>\n          <div style="color: white"></div>\n        </div>\n        <style>\n        #spinner {\n          z-index: 40;\n          align-content: center;\n          width: 100%;\n          height: 100%;\n          display: flex;\n          position: absolute;\n          align-items: center;\n          justify-content: center;\n          background: rgba(20, 20, 20, 1);\n          top: 0;\n        }\n        .lds-ripple {\n          width: 80px;\n          height: 80px;\n          position: relative;\n        }\n        .lds-ripple div {\n          position: absolute;\n          border: 4px solid #000;\n          opacity: 1;\n          border-radius: 50%;\n          border-color: white;\n          animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;\n        }\n        .lds-ripple div:nth-child(2) {\n          animation-delay: -0.5s;\n        }\n        @keyframes lds-ripple {\n          0% {\n            top: 36px;\n            left: 36px;\n            width: 0;\n            height: 0;\n            opacity: 1;\n            color: white;\n          }\n          100% {\n            top: 0px;\n            left: 0px;\n            width: 72px;\n            height: 72px;\n            opacity: 0;\n          }\n        }\n        </style>\n      </div>')}removeLoading(){const e=document.getElementById("spinner");e&&e.remove()}confirmPicture(){const e={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({base64:{key:this.base64.replace("data:image/png;base64,","")}})};this.setLoading();const t=`${this.livenessUrlBase}${this.livenessConfirmEndpoint}`;fetch(t,e).then((e=>e.json())).then((e=>{if(e&&e.error&&401===e.error.statusCode)return alert("Token inválido"),this.resetLiveness(),void this.errorCallback(e);let t=!1;e&&e.data&&e.data.real&&parseFloat(e.data.real)>.97&&(t=!0),e&&e.isAlive&&(t=!0),t?this.successCallback(e):this.errorCallback(e)})).catch((e=>{console.log("error",e),this.errorCallback(e)})).finally((()=>{this.resetLiveness(),this.removeLoading()}))}}}},t={},i=function i(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,i),o.exports}(648);Liveness=i})();
//# sourceMappingURL=liveness.js.map