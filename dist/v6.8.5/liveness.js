var Liveness;(()=>{"use strict";var e={365:e=>{e.exports=class{constructor(e,t){this.uploadInProgress=0,this.requestType="b64",this.counterNotFoundFace=0,this.faceapi=null,this.token=t.token,this.videoWrapper=e,this.configFrameBox=t.frameBox,this.boxMessages={unmatchedFace:"Face não encaixada",keepNeutralFace:"Mantenha expressão neutra",centerYourFace:"Alinhe seu rosto à tela",darkEnvironment:"O ambiente está escuro",positionFaceWithinFrame:"Posicione seu rosto dentro da moldura",moveFaceAway:"Afaste seu rosto",moveFaceCloser:"Aproxime seu rosto",moveFaceDown:"Desça a cabeça para encaixar na moldura",moveFaceUp:"Suba a cabeça para encaixar na moldura",moveFaceRight:"Mova a cabeça para a direita",moveFaceLeft:"Mova a cabeça para a esquerda"},t.scalingFactorForLiveness&&0!==t.scalingFactorForLiveness&&t.scalingFactorForLiveness<=3?this.scalingFactorForLiveness=t.scalingFactorForLiveness:this.scalingFactorForLiveness=1,this.config={ellipseMaskWidth:t.ellipseMaskWidth,ellipseMaskHeight:t.ellipseMaskHeight,ellipseMaskTop:t.ellipseMaskTop,ellipseMaskLeft:t.ellipseMaskLeft,mobileFacingMode:t.mobileFacingMode||"user",width:t.width||this.getFullWidth(),height:t.height||this.getFullHeight()},this.config.heightAspectRatio=this.isMobile()?this.config.width*(4/3):this.config.width/(4/3),this.config.isDebug=t.isDebug;const i=document.createElement("style");i.innerText=this.cssOrientationLock(),document.head.appendChild(i),t.brightnessControl?this.brightnessControl=t.brightnessControl:this.brightnessControl=95,t.luminanceControl?this.luminanceControl=t.luminanceControl:this.luminanceControl=23,this.faceapiPath=t.faceapiPath,this.isShowPreview=t.isShowPreview,this.errorCallback=t.errorCallback,this.successCallback=t.successCallback,this.livenessUrlBase=t.livenessUrlBase,this.livenessConfirmEndpoint=t.livenessConfirmEndpoint||"/liveness/v2",this.ellipseStrokeStyleDefault=t.ellipseStrokeStyle||"#D02780",this.activatedEllipseStrokeStyle=t.activatedEllipseStrokeStyle||"#46E3C3",this.boxMessageBackgroundColor=t.boxMessageBackgroundColor||"#D02780",this.boxMessageTextColor=t.boxMessageTextColor||"#f3f3f5",this.configEyesBoxHeight=t.configEyesBoxHeight||20,this.requestAnimationFrame=window.requestAnimationFrame,this.shouldCheckNeutralFace=t.shouldCheckNeutralFace||!1,this.facetimeInterval=t.facetimeInterval||150,this.timeToDetectFace=t.timeToDetectFace||6e3,this.showNotFoundModal=t.showNotFoundModal||!1,this.cameraPermissionErrorCallback=t.cameraPermissionErrorCallback||null,this.ignoreFaceRules=t.ignoreFaceRules||!1,this.activateCountdown=t.activateCountdown||!1,this.validations=this.ignoreFaceRules?["faceLeft","faceRight","faceAbove","faceBelow","notInsideEllipse"]:["background","faceLeft","faceRight","insideFrameBox","faceAbove","faceBelow","faceAway","faceCloser","faceNotBetweenEyesBox"],this.validations=t.validations||this.validations}getFullWidth(){return Math.max(document.body.scrollWidth,document.documentElement.scrollWidth,document.body.offsetWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth)}getFullHeight(){return Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight)}setUseBase64(){this.requestType="b64"}setUseFormData(){this.requestType="formData"}setMinBrightness(e){this.brightnessControl=e}setMinLuminance(e){this.luminanceControl=e}setMobileFaceCam(){this.config.mobileFacingMode="user",this.resetLiveness()}setMobileEnvironmentCam(){this.config.mobileFacingMode="environment",this.resetLiveness()}setFrameBoxesWidth(e,t,i){this.configFrameBox={eyesInner:e,eyesOutter:t,box:i}}setDimensionsRequestImage(e,t){this.config.dimensions={width:e,height:t}}toggleDebug(){this.config.isDebug=!this.config.isDebug,this.config.isDebug||this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}setEyesBoxHeight(e){this.configEyesBoxHeight=e}stop(){this.video.pause(),this.stream.getTracks().forEach((e=>e.stop())),clearInterval(this.timer),clearInterval(this.timerBackground)}setCheckNeutralFace(e){this.shouldCheckNeutralFace=e}async start(e){this.startCallbackFunction=e,window.faceapi?(this.faceapi=window.faceapi,this.setLiveness()):await this.loadFaceApi()}setLiveness(){this.setLoading(),this.createVideoElement().startVideo().createModalConfirmationWrapper().createModalConfirmation()}destroyLiveness(){this.stop(),this.removeCanvas(),this.resetVideoWrapper()}resetLiveness(){this.stop(),this.removeCanvas(),this.resetVideoWrapper(),this.closePreviewModal(),this.base64="",this.removeLoading(),this.setLiveness()}cssOrientationLock(){return"@media screen and (min-width: 320px) and (max-width: 767px) and (orientation: landscape) { html { transform: rotate(-90deg);transform-origin: left top;width: 100vh;overflow-x: hidden;position: absolute;top: 100%;left: 0;}}"}createCanvasBackground(){this.canvasBackground=document.createElement("canvas"),this.videoWrapper.clientWidth,this.getDevicePixelRatio(),this.videoWrapper.clientHeight,this.getDevicePixelRatio(),this.canvasBackground.width=this.isMobile()?this.video.clientWidth*(window.devicePixelRatio||2):this.config.width,this.canvasBackground.height=this.isMobile()?this.config.heightAspectRatio*(window.devicePixelRatio||2):this.config.height,this.scalingFactorForLiveness&&(this.canvasBackground.width=this.canvasBackground.width*this.scalingFactorForLiveness,this.canvasBackground.height=this.canvasBackground.height*this.scalingFactorForLiveness),this.config.dimensions&&(this.canvasBackground.width=this.config.dimensions.width,this.canvasBackground.height=this.config.dimensions.height),this.canvasBackground.style.display="none"}sweepVideo(e){this.luminanceAvg=0,this.brightnessSum=0,this.luminanceArray=[];for(let t=0;t<e.length;t+=4){const i=e[t],s=e[t+1],n=e[t+2];this.sweepBrightness(i,s,n),this.sweepLuminance(i,s,n)}this.checkBrightness()}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}checkBrightness(){this.brightness=Math.floor(this.brightnessSum/(this.canvasLuminance.width*this.canvasLuminance.height))}sweepBrightness(e,t,i){this.brightnessSum+=Math.floor((e+t+i)/3)}sweepLuminance(e,t,i){this.luminanceAvg+=this.calcLuminance(e,t,i),this.luminanceArray.push(this.calcLuminance(e,t,i)),this.luminance=this.luminanceAvg/this.luminanceArray?.length*100}calcLuminance(e,t,i){let s,n=[e,t,i];for(let e=0;e<n.length;e++)s=n[e]/255,s<=.03928?s/=12.92:s=Math.pow((s+.055)/1.055,2.4),n[e]=s;return.2126*n[0]+.7152*n[1]+.0722*n[2]+.05}getDevicePixelRatio(){let e;const t=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;return void 0===window.devicePixelRatio||t?window.matchMedia?(e="(-webkit-min-device-pixel-ratio: 1.5),        (min--moz-device-pixel-ratio: 1.5),        (-o-min-device-pixel-ratio: 3/2),        (min-resolution: 1.5dppx)",window.matchMedia(e).matches?1.5:(e="(-webkit-min-device-pixel-ratio: 2),        (min--moz-device-pixel-ratio: 2),        (-o-min-device-pixel-ratio: 2/1),        (min-resolution: 2dppx)",window.matchMedia(e).matches?2:(e="(-webkit-min-device-pixel-ratio: 0.75),        (min--moz-device-pixel-ratio: 0.75),        (-o-min-device-pixel-ratio: 3/4),        (min-resolution: 0.75dppx)",window.matchMedia(e).matches?1.5:void 0))):1:window.devicePixelRatio}async loadFaceApi(){const e=document.createElement("script"),t=`${this.faceapiPath}/face-api.min.js`;return e.src=t,document.head.append(e),e.onload=async()=>{await this.loadFaceApiModels()},this}async loadFaceApiModels(){return setTimeout((async()=>{Promise.all([window.faceapi.nets.faceLandmark68Net.loadFromUri(this.faceapiPath),window.faceapi.nets.faceExpressionNet.loadFromUri(this.faceapiPath),window.faceapi.nets.faceRecognitionNet.loadFromUri(this.faceapiPath)]).then((async()=>{await window.faceapi.nets.tinyFaceDetector.loadFromUri(this.faceapiPath),console.log("Models were loaded"),this.faceapi=faceapi,this.setLiveness()})).catch((e=>console.error("error",e)))}),100),this}startVideo(){return void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(i,s){t.call(navigator,e,i,s)})):Promise.reject(new Error("getUserMedia não implementado nesse browser"))}),navigator.mediaDevices.enumerateDevices().then((e=>{const t={video:{width:this.config.width,height:this.config.height,frameRate:24}};if(this.isMobile())t.video={facingMode:this.config.mobileFacingMode};else{const i=e.filter((e=>"videoinput"===e.kind&&!e.label.includes("m-de:vice")))[0];i&&(t.video.deviceId=i.deviceId)}navigator.mediaDevices.getUserMedia(t).then((e=>{const t=document.querySelector("video");t&&(this.stream=e,navigator.streamLiveness=e,"srcObject"in t?t.srcObject=e:t.src=window.URL.createObjectURL(e),this.startCallbackFunction&&this.startCallbackFunction())})).catch((e=>{if(!this.cameraPermissionErrorCallback)throw new Error(e);this.cameraPermissionErrorCallback(e)}))})),this}createVideoElement(){return this.videoWrapper.style.position="relative",this.videoWrapper.style.width=this.config.width+"px",this.videoWrapper.style.height=this.config.height<this.config.heightAspectRatio?this.config.height+"px":this.config.heightAspectRatio+"px",this.video=document.createElement("video"),this.video.ariaLabel="Vídeo da face - Aproxime o rosto em posição de selfie e afaste-o lentamente para enquadrar",this.video.style.width="inherit",this.video.style.height="inherit","user"===this.config.mobileFacingMode&&(this.video.style.transform="scaleX(-1)"),this.video.setAttribute("muted",!0),this.video.setAttribute("autoplay",!0),this.video.setAttribute("playsinline",""),this.videoWrapper.append(this.video),this.video.addEventListener("play",(()=>{this.loop(),this.createCanvasBackground()})),this}resetVideoWrapper(){const e=document.getElementById("video-wrapper");e&&(e.innerHTML="")}removeCanvas(){const e=document.getElementsByTagName("canvas")[0];e&&e.remove()}responsiveFrameBoxEyesOutterWidth(e){switch(e){case 315:return{eyesInner:.74,eyesOutter:.78,box:.55};default:return{eyesInner:.52,eyesOutter:.82,box:.6}}}loop(){this.blockMaskMessage=this.boxMessages.unmatchedFace,this.canvas=this.faceapi.createCanvasFromMedia(this.video),this.canvas.style.position="absolute",this.canvas.style.left=0,this.canvas.style.top=0,this.videoWrapper.append(this.canvas);const e={width:this.config.width,height:this.config.height<this.config.heightAspectRatio?this.config.height:this.config.heightAspectRatio};this.faceapi.matchDimensions(this.canvas,e),this.boxesWidth=this.responsiveFrameBoxEyesOutterWidth(window.innerWidth),this.configFrameBox&&(this.boxesWidth=this.configFrameBox);const t={width:Math.floor(this.config.width*this.boxesWidth.box),height:this.config.height<this.config.heightAspectRatio?this.config.height:this.config.heightAspectRatio};this.configFrameBox?.height&&(t.height=this.configFrameBox.height),t.left=Math.floor(this.canvas.width/2-t.width/2),t.top=Math.floor(this.videoWrapper.clientHeight/2-t.height/2),t.center=(t.left+t.width)/1.5;const i=t.height+this.configEyesBoxHeight,s={width:Math.floor(t.width*this.boxesWidth.eyesOutter),height:Math.floor(i/5),top:Math.floor(t.top+.3*t.height)};s.left=Math.floor(t.left+t.width/1.95-s.width/1.95);const n={width:Math.floor(t.width*this.boxesWidth.eyesInner),height:Math.floor(i/5),top:Math.floor(t.top+.3*t.height)};n.left=Math.floor(t.left+t.width/1.96-n.width/1.96),this.ellipseMaskWidth=this.config.ellipseMaskWidth?t.width/this.config.ellipseMaskWidth:t.width/2,this.ellipseMaskHeight=this.config.ellipseMaskHeight?t.height/this.config.ellipseMaskHeight:t.height/2.5,this.ellipseMaskTop=this.config.ellipseMaskTop?(t.top+t.height)/this.config.ellipseMaskTop:(t.top+t.height)/1.9,this.ellipseMaskLeft=this.config.ellipseMaskLeft?s.left+s.width/this.config.ellipseMaskLeft:s.left+s.width/2,this.ellipseMaskLineWidth=2,this.createMessageBox();const o=this.canvas.getContext("2d");o.translate(this.canvas.width,0),o.scale(-1,1),this.drawEllipse(o),this.config.isDebug&&this.draw(o,this.canvas,t,n,s),this.isMobile()?this.isBackgroundOK=!0:this.timerBackground=setInterval((()=>{this.checkBackground()}),1e3);const a={counter:0,inProgress:!1,done:!1},r=this.canvas.getBoundingClientRect();this.timer=setInterval((async()=>{if(!navigator.onLine)return void this.setHasNoNetwork();if(a.inProgress||a.done)return;a.inProgress=!0;const e=await this.faceapi.detectSingleFace(this.video,new this.faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceExpressions();this.removeLoading();const i=this.timeToDetectFace/this.facetimeInterval;if(this.showNotFoundModal&&this.counterNotFoundFace>i&&this.toggleModalFaceNotFound(),!e)return this.blockMaskMessage=this.boxMessages.unmatchedFace,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,a.inProgress=!1,void this.counterNotFoundFace++;this.counterNotFoundFace=0;const h=this.faceapi.resizeResults(e,{width:this.config.width,height:this.config.height<this.config.heightAspectRatio?this.config.height:this.config.heightAspectRatio});if(h&&h.expressions&&this.shouldCheckNeutralFace){const e=this.getExpression(h.expressions);if("neutral"!==e)return this.config.isDebug?(this.blockMaskMessage=`${this.boxMessages.keepNeutralFace} >> ${e}`,this.blockMask(r,t.left,t.top,t.height,t.width)):(this.blockMaskMessage=this.boxMessages.keepNeutralFace,this.blockMask(r,t.left,t.top,t.height,t.width)),a.counter=0,void(a.inProgress=!1)}if(h.detection){const e=this.getPose(h);if("front"!==e)return this.config.isDebug?(this.blockMaskMessage=`${this.boxMessages.centerYourFace} >> ${e}`,this.blockMask(r,t.left,t.top,t.height,t.width)):(this.blockMaskMessage=this.boxMessages.centerYourFace,this.blockMask(r,t.left,t.top,t.height,t.width)),a.counter=0,void(a.inProgress=!1);const i=h.landmarks.getJawOutline();if(this.isRotatedFace(i[0],i[16]))return this.config.isDebug?(this.blockMaskMessage=`${this.boxMessages.centerYourFace} >> rotacionado`,this.blockMask(r,t.left,t.top,t.height,t.width)):(this.blockMaskMessage=this.boxMessages.centerYourFace,this.blockMask(r,t.left,t.top,t.height,t.width)),a.counter=0,void(a.inProgress=!1);this.config.isDebug&&(this.draw(o,this.canvas,t,n,s),o.beginPath(),o.lineWidth="5",o.strokeStyle="#FFFF00",o.moveTo(i[0].x,i[0].y),o.lineTo(i[16].x,i[16].y),o.stroke());const c={meanPosition:[i[0].x,i[0].y]},l={meanPosition:[i[16].x,i[16].y]},d=[i[8].x,i[8].y],g={frameboxTop:t.top,frameboxLeft:t.left,frameboxWidth:t.width,frameboxHeight:t.height,frameboxCenter:t.center,eyesOutterTop:s.top,eyesOutterLeft:s.left,eyesOutterWidth:s.width,eyesOutterHeight:s.height,eyesInnerTop:n.top,eyesInnerLeft:n.left,eyesInnerWidth:n.width,eyesInnerHeight:n.height};if(this.hasBackgroundValidation()&&!this.isBackgroundOK)return this.blockMaskMessage=this.boxMessages.darkEnvironment,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasFaceLeftValidation()&&this.isFaceLeft(d,g))return this.blockMaskMessage=this.boxMessages.moveFaceRight,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasFaceRightValidation()&&this.isFaceRight(d,g))return this.blockMaskMessage=this.boxMessages.moveFaceLeft,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasInsideFrameBoxValidation()&&!this.isInsideFramebox(c.meanPosition,l.meanPosition,g))return this.blockMaskMessage=this.boxMessages.positionFaceWithinFrame,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasFaceAboveValidation()&&this.isFaceAbove(c.meanPosition,l.meanPosition,g))return this.blockMaskMessage=this.boxMessages.moveFaceDown,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasFaceBelowValidation()&&this.isFaceBelow(c.meanPosition,l.meanPosition,g))return this.blockMaskMessage=this.boxMessages.moveFaceUp,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasFaceAwayValidation()&&this.isFaceAway(c.meanPosition,l.meanPosition,g))return this.blockMaskMessage=this.boxMessages.moveFaceCloser,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasFaceCloserValidation()&&this.isFaceCloser(c.meanPosition,l.meanPosition,g))return this.blockMaskMessage=this.boxMessages.moveFaceAway,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasFaceNotBetweenEyesBoxValidation()&&this.isNotBetweenEyesBoxes(c.meanPosition,l.meanPosition,g))return this.blockMaskMessage=this.boxMessages.moveFaceCloser,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);if(this.hasNotInsideEllipeValidation()&&this.isNotInsideEllipse(c.meanPosition,l.meanPosition))return this.blockMaskMessage=this.boxMessages.positionFaceWithinFrame,this.blockMask(r,t.left,t.top,t.height,t.width),a.counter=0,void(a.inProgress=!1);this.ellipseMaskLineWidth<6&&(this.ellipseMaskLineWidth*=2),this.activateEllipseMask(),a.counter+=1,a.inProgress=!1,a.counter>=2?(a.done=!0,clearInterval(this.timer),this.timerBackground&&clearInterval(this.timerBackground),this.removeMessageBox(),this.activateCountdown?this.countdown():this.takePicture()):clearInterval(this.counterInterval)}}),this.facetimeInterval)}hasBackgroundValidation(){return this.validations.includes("background")}hasFaceLeftValidation(){return this.validations.includes("faceLeft")}hasFaceRightValidation(){return this.validations.includes("faceRight")}hasInsideFrameBoxValidation(){return this.validations.includes("insideFrameBox")}hasFaceAboveValidation(){return this.validations.includes("faceAbove")}hasFaceBelowValidation(){return this.validations.includes("faceBelow")}hasFaceAwayValidation(){return this.validations.includes("faceAway")}hasFaceCloserValidation(){return this.validations.includes("faceCloser")}hasFaceNotBetweenEyesBoxValidation(){return this.validations.includes("faceNotBetweenEyesBox")}hasNotInsideEllipeValidation(){return this.validations.includes("notInsideEllipse")}countdown(){this.counter=3,this.counterInterval=setInterval((()=>{this.printCountdown(),this.counter--,this.counter<0&&(clearInterval(this.counterInterval),this.takePicture())}),1e3)}printCountdown(){const e=document.getElementById("countdown");e&&e.remove();const t=`\n        <div\n          role="alert"\n          id="countdown"\n          aria-label="contagem regressiva ${this.counter}"\n        >\n          <div class="lds-countdown">\n            <strong>${this.counter}</strong>\n          </div>\n          <strong>Evite se movimentar agora</strong>\n        <style>\n        #countdown {\n          top: 0;\n          gap:3rem;\n          z-index: 999;\n          width: 100%;\n          height: 100%;\n          color: white;\n          display: flex;\n          position: absolute;\n          text-align: center;\n          align-items: center;\n          flex-direction: column;\n          justify-content: center;\n          background-color: rgba(50, 50, 50, 0.4);\n        }\n        .lds-countdown {\n          width: 80px;\n          height: 80px;\n          position: relative;\n        }\n        #countdown > strong {\n          font-size: 1.8rem;\n          padding: 0.5rem;\n          background: black;\n          border-radius: 1rem;\n        }\n        .lds-countdown strong {\n          font-size: 5rem;\n          padding: 0.5rem;\n          background: black;\n          border-radius: 1rem;\n        }\n        </style>\n      </div>`;this.videoWrapper.insertAdjacentHTML("beforeend",t)}activateEllipseMask(){const e=this.canvas.getContext("2d");this.drawEllipse(e,this.activatedEllipseStrokeStyle)}deactivateEllipseMask(){const e=this.canvas.getContext("2d");this.ellipseMaskLineWidth=3,this.drawEllipse(e)}getExpression(e){const t=[];for(const[i,s]of Object.entries(e))t.push({expression:i,confidence:s});const i=t.sort(((e,t)=>e.confidence-t.confidence)).pop();return i&&i.expression?i.expression:null}getPose(e){const t=this.getMeanPosition(e.landmarks.getRightEye()),i=this.getMeanPosition(e.landmarks.getLeftEye()),s=this.getMeanPosition(e.landmarks.getNose()),n=this.getMeanPosition(e.landmarks.getMouth()),o=(this.getTop(e.landmarks.getJawOutline())-n[1])/e.detection.box.height+.45,a=(i[0]+(t[0]-i[0])/2-s[0])/e.detection.box.width;let r="undetected";return e.detection.score>.3&&(r="front",o>.2?r="top":o<-.1?r="bottom":(a<-.04&&(r="left"),a>.04&&(r="right"))),r}isRotatedFace(e,t){return Math.abs(180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI)>7}getMeanPosition(e){return e.map((e=>[e.x,e.y])).reduce(((e,t)=>[e[0]+t[0],e[1]+t[1]])).map((t=>t/e.length))}getTop(e){return e.map((e=>e.y)).reduce(((e,t)=>Math.min(e,t)))}isInside(e=[],t={}){return!(e[1]<t.top||e[0]<t.left||e[1]>t.top+t.height||e[0]>t.left+t.width)}isFaceUp(e=[],t){return e[1]<t}isFaceDown(e=[],t){return e[1]>t}isFaceLeft(e,t){const i=t.frameboxCenter- -.05*t.frameboxCenter;return e[0]>i}isFaceRight(e,t){const i=t.frameboxCenter+-.05*t.frameboxCenter;return e[0]<i}isInsideFramebox(e,t,i){const s={top:i.frameboxTop,left:i.frameboxLeft,width:i.frameboxWidth,height:i.frameboxHeight};return this.isLeftEyeInsideFramebox(e,s)&&this.isRightEyeInsideFramebox(t,s)}isLeftEyeInsideFramebox(e,t){return this.isInside(e,t)}isRightEyeInsideFramebox(e,t){return this.isInside(e,t)}isFaceAway(e,t,i){const s={top:i.eyesInnerTop,left:i.eyesInnerLeft,width:i.eyesInnerWidth,height:i.eyesInnerHeight};return this.isLeftEyeAway(e,s)&&this.isRightEyeAway(t,s)}isLeftEyeAway(e,t){return this.isInside(e,t)}isRightEyeAway(e,t){return this.isInside(e,t)}isFaceCloser(e,t,i){const s={top:i.eyesOutterTop,left:i.eyesOutterLeft,width:i.eyesOutterWidth,height:i.eyesOutterHeight};return this.isLeftEyeCloser(e,s)&&this.isRightEyeCloser(t,s)}isLeftEyeCloser(e,t){return!this.isInside(e,t)}isRightEyeCloser(e,t){return!this.isInside(e,t)}isFaceBelow(e,t,i){return this.isLeftEyeBelow(e,i)||this.isRightEyeBelow(t,i)}isLeftEyeBelow(e,t){return e[1]>t.eyesOutterTop+t.eyesOutterHeight}isRightEyeBelow(e,t){return e[1]>t.eyesOutterTop+t.eyesOutterHeight}isFaceAbove(e,t,i){return this.isLeftEyeAbove(e,i)||this.isRightEyeAbove(t,i)}isLeftEyeAbove(e,t){return e[1]<t.eyesOutterTop}isRightEyeAbove(e,t){return e[1]<t.eyesOutterTop}isNotBetweenEyesBoxes(e,t,i){const s=t[0]<i.eyesOutterLeft+i.eyesOutterWidth&&t[0]>i.eyesInnerLeft+i.eyesInnerWidth,n=e[0]>i.eyesOutterLeft&&e[0]<i.eyesInnerLeft;return!(s&&n)}isNotInsideEllipse(e,t){return!(this.isLeftEyeInsideEllipse(e)&&this.isRightEyeInsideEllipse(t))}isLeftEyeInsideEllipse(e){const t=e[1]>this.ellipseMaskTop-this.ellipseMaskHeight&&e[1]<this.ellipseMaskTop+(this.ellipseMaskTop-this.ellipseMaskHeight),i=e[0]<this.ellipseMaskLeft&&e[0]>this.ellipseMaskLeft-this.ellipseMaskWidth/2;return t&&!i}isRightEyeInsideEllipse(e,t){const i=e[1]>this.ellipseMaskTop-this.ellipseMaskHeight&&e[1]<this.ellipseMaskTop+(this.ellipseMaskTop-this.ellipseMaskHeight),s=e[0]<this.ellipseMaskLeft&&e[0]>this.ellipseMaskLeft-4*this.ellipseMaskWidth;return i&&!s}blockMask(e,t,i,s,n){const o={width:230,height:35};if(o.top=i+s+20,o.left=t+n/2-o.width/2,this.blockMaskMessage===this.cachedBlockMaskMessage)return;this.cachedBlockMaskMessage=this.blockMaskMessage,this.deactivateEllipseMask(),this.msg.innerHTML="";const a=document.createElement("span");a.role="alert",a.ariaLabel="Alinhe seu rosto à tela"===this.blockMaskMessage?"Seu rosto está inclinado, deixe-o alinhado à tela":this.blockMaskMessage,a.textContent=this.blockMaskMessage,a.style=`\n      display: flex;\n      color: ${this.boxMessageTextColor};\n      font-size: 1.1rem;\n      padding: 10px 20px;\n      text-align: center;\n      align-items: center;\n      background: ${this.boxMessageBackgroundColor};\n      border-radius: 7px;\n      justify-content: center;\n      width: ${o.width}px;\n      font-family: Prompt, sans-serif;\n    `,this.msg.style.display="flex",this.msg.appendChild(a)}draw(e,t,i,s,n){e.clearRect(0,0,t.width,t.height),e.beginPath(),e.lineWidth=1,e.strokeStyle="green",e.rect(i.center,i.top,2,i.height),e.stroke(),e.beginPath(),e.lineWidth=3,e.strokeStyle="blue",e.rect(i.left,i.top,i.width,i.height),e.stroke(),e.beginPath(),e.lineWidth=2,e.strokeStyle="yellow",e.rect(s.left,s.top,s.width,s.height),e.stroke(),e.beginPath(),e.lineWidth=2,e.strokeStyle="red",e.rect(n.left,n.top,n.width,n.height),e.stroke(),this.drawEllipse(e)}drawEllipse(e,t){const i=this.ellipseMaskLeft,s=this.ellipseMaskTop,n=this.ellipseMaskWidth,o=this.ellipseMaskHeight;e.beginPath(),e.lineWidth=this.ellipseMaskLineWidth,e.ellipse(i,s,n,o,0,0,2*Math.PI),e.strokeStyle=t||this.ellipseStrokeStyleDefault,e.stroke()}takePicture(){const e=this.canvasBackground.getContext("2d");this.canvasBackground.style.display="none;",this.createFlashMask(),e.drawImage(this.video,0,0,this.canvasBackground.width,this.canvasBackground.height),e.fillStyle="#475444",e.fillRect(20,50,1,1),e.fillStyle="#D3BE7C",e.fillRect(422,522,1,1);const t=e.getImageData(0,0,this.canvasBackground.width,this.canvasBackground.height);e.putImageData(t,0,0),this.base64=this.canvasBackground.toDataURL("image/png"),setTimeout((()=>{this.removeFlashMask(),this.isShowPreview?this.openPreviewModal():this.confirmPicture()}),300)}checkBackground(){this.canvasLuminance=document.createElement("canvas"),this.videoWrapper.clientWidth,this.videoWrapper.clientHeight;const e=this.canvasLuminance.getContext("2d");e.drawImage(this.video,0,0,this.canvasLuminance.width,this.canvasLuminance.height);const t=e.getImageData(0,0,this.canvasLuminance.width,this.canvasLuminance.height);this.sweepVideo(t.data),this.isBackgroundOK=this.brightness>=this.brightnessControl&&this.luminance>=this.luminanceControl,this.config.isDebug&&(this.brightness,this.brightnessControl,parseFloat(this.luminance.toFixed(2)),this.luminanceControl)}createFlashMask(){const e=document.createElement("div");e.style.width="100%",e.style.height="100vh",e.style.position="fixed",e.style.background="white",e.style.zIndex=999,e.style.top=0,e.style.left=0,e.id="flash",document.body.append(e)}removeFlashMask(){document.getElementById("flash").remove()}createMessageBox(){const e=document.getElementById("liveness-box-message");return e&&e.remove(),this.msg=document.createElement("div"),this.msg.id="liveness-box-message",this.msg.style=`\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      width: 100%;\n      z-index: 999;\n      background: transparent;\n      position: absolute;\n      top: ${this.ellipseMaskTop+this.ellipseMaskHeight}px;\n    `,this.videoWrapper.append(this.msg),this}removeMessageBox(){const e=document.getElementById("liveness-box-message");e&&e.remove()}toggleModalFaceNotFound(){if(document.getElementById("modal-liveness-face-not-found"))return;const e=document.createElement("div");e.id="modal-liveness-face-not-found",e.style="\n    top: 0;\n    left: 0;\n    z-index: 21;\n    width: 100%;\n    height: 100%;\n    position: fixed;\n    display: grid;\n    align-items: flex-start;\n    justify-content: center;\n    background: rgba(20, 20, 20, 0.95);\n    ";const t=document.createElement("div");t.style="\n    gap: 10px;\n    margin-top: 50px;\n    padding: 15px 10px;\n    display: grid;\n    background: white;\n    border-radius: 7px;\n    position: relative;\n    align-items: center;\n    justify-content: center;\n    font-family: Prompt, sans-serif;\n    ",t.innerHTML='\n      <h3>Atenção</h3>\n      <p role="alert" style="width: 100%">Não foi possível realizar a captura, tente novamente:</p>\n      <ul style="width: 100%; display: grid; gap: 5px;">\n        <li>Em um fundo neutro, de preferência com uma parede clara</li>\n        <li>Em um ambiente com iluminação neutra (nem muito claro nem muito escuro)</li>\n        <li>Removendo os adereços que prejudiquem a visualização da sua face, como cachecol, tocas, bonés e fones</li>\n      </ul>\n    ';const i=document.createElement("button");i.textContent="OK",i.style="\n    color: #555;\n    right: 10px;\n    width: 130px;\n    height: 30px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const s=document.createElement("div");return s.style="\n    z-index: 1;\n    width: 100%;\n    display: flex;\n    padding: 10px 0;\n    justify-content: center;\n    ",s.append(i),t.append(s),e.append(t),i.addEventListener("click",(()=>{this.counterNotFoundFace=0;const e=document.getElementById("modal-liveness-face-not-found");e&&e.remove()})),document.body.append(e),i.focus(),this}createModalConfirmationWrapper(){return this.modalWrapper=document.createElement("div"),this.modalWrapper.style=`\n    top: 0;\n    left: 0;\n    z-index: 999;\n    width: ${this.videoWrapper.style.width};\n    height: ${this.videoWrapper.style.height};\n    display: none;\n    position: fixed;\n    align-items: flex-start;\n    justify-content: center;\n    background: rgba(20, 20, 20, 0.95);\n    `,this.modalWrapper.id="modalWrapper",document.body.append(this.modalWrapper),this}createModalConfirmation(){this.modalConfirmation=document.createElement("div"),this.modalConfirmation.ariaLabel="Foto tirada com sucesso",this.modalConfirmation.role="alert",this.modalConfirmation.style=`\n    padding: 7px;\n    display: flex;\n    width: ${this.videoWrapper.style.width};\n    height: ${this.videoWrapper.style.height};\n    background: white;\n    border-radius: 7px;\n    position: relative;\n    align-items: center;\n    justify-content: center;\n    `;const e=document.createElement("button");e.textContent="Confirmar",e.style="\n    color: #555;\n    right: 10px;\n    width: 160px;\n    height: 50px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const t=document.createElement("button");t.textContent="Cancelar",t.style="\n    color: #444;\n    right: 10px;\n    width: 160px;\n    height: 50px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const i=document.createElement("div");return i.style="\n    right: 0;\n    bottom: 0;\n    z-index: 1;\n    width: 100%;\n    display: flex;\n    padding: 10px 0;\n    position: absolute;\n    justify-content: center;\n    ",i.append(t),i.append(e),this.modalConfirmation.append(i),this.modalWrapper.append(this.modalConfirmation),e.addEventListener("click",(()=>{this.closePreviewModal(),this.confirmPicture()})),t.addEventListener("click",(()=>{this.cancelPicture()})),e.focus(),this}openPreviewModal(){const e=document.createElement("img");e.src=this.base64,e.style=`\n    width: 100%;\n    height: 100%;\n    max-width: ${this.videoWrapper.clientWidth};\n    object-fit: cover;\n    border-radius: 7px;\n    transform: scaleX(-1);\n    `,this.modalConfirmation.append(e),this.modalWrapper.style.display="flex"}closePreviewModal(){const e=document.getElementById("modalWrapper");e&&e.remove()}cancelPicture(){this.resetLiveness()}downloadImage(){const e=createElement("a");e.setAttribute("download","image.png"),e.setAttribute("href",this.base64),e.click(),setTimeout((()=>{e.remove()}),1e3)}setLoading(){document.getElementById("spinner")||this.videoWrapper.insertAdjacentHTML("beforeend",'<div id="spinner">\n        <div class="lds-ripple">\n          <div style="color: white"></div>\n          <div style="color: white"></div>\n        </div>\n        <div id="spinner-message" />\n        <style>\n        #spinner {\n          top: 0;\n          z-index: 999;\n          width: 100%;\n          height: 100%;\n          display: flex;\n          position: absolute;\n          align-items: center;\n          flex-direction: column;\n          justify-content: center;\n          background: rgba(20, 20, 20, 1);\n        }\n        #spinner-message {\n          width: 100%;\n          display: flex;\n        }\n        .lds-ripple {\n          width: 80px;\n          height: 80px;\n          position: relative;\n        }\n        .lds-ripple div {\n          position: absolute;\n          border: 4px solid #000;\n          opacity: 1;\n          border-radius: 50%;\n          border-color: white;\n          animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;\n        }\n        .lds-ripple div:nth-child(2) {\n          animation-delay: -0.5s;\n        }\n        @keyframes lds-ripple {\n          0% {\n            top: 36px;\n            left: 36px;\n            width: 0;\n            height: 0;\n            opacity: 1;\n            color: white;\n          }\n          100% {\n            top: 0px;\n            left: 0px;\n            width: 72px;\n            height: 72px;\n            opacity: 0;\n          }\n        }\n        </style>\n      </div>')}setLoadingAccessibilityProgress(){this.removeLoadingAccessibilityProgress(),this.videoWrapper.insertAdjacentHTML("beforeend",'<div id="spinneracc" role="alert" style="opacity: 0">\n        <p class="liveness-progress-text-accessibility">\n          Aguarde enquanto estamos carregando e analisando a sua selfie\n        </p>\n      </div>')}removeLoadingAccessibilityProgress(){const e=document.getElementById("spinneracc");e&&e.remove()}setLoadingProgress(){if(document.getElementById("spinner"))return;const e=`<div id="spinner">\n        <p class="liveness-progress-text">\n          ${100===this.uploadInProgress?"<strong>Aguarde enquanto estamos <br /> analisando a sua selfie</strong>":`Fazendo upload da selfie...<br /> (${this.uploadInProgress?.toFixed(0)}% enviados)`}\n        </p>\n    \n        <style>\n        #spinner {\n          top: 0;\n          z-index: 999;\n          width: 100%;\n          height: 100%;\n          display: flex;\n          position: absolute;\n          align-items: center;\n          flex-direction: column;\n          justify-content: center;\n          background: rgba(20, 20, 20, 1);\n        }\n        .liveness-progress-text {\n          color: white;\n          text-align: center;\n        }\n        .liveness-progress-text strong {\n          opacity: 1;\n          animation: blink-text 1s ease infinite alternate;\n        }\n        @keyframes blink-text {\n          from {\n            opacity: 1;\n          }\n          to {\n            opacity: 0.4;\n          }\n        }\n        </style>\n      </div>`;this.videoWrapper.insertAdjacentHTML("beforeend",e)}getTips(e){const t=[],i=JSON.parse(e?.response);return 401===e.status?(t.push(`Verifique seu token. Token inválido ou não possui permissão para esse produto::${i?.error?.message}`),t.join(", ")):e.status>=500?(t.push(`Ocorreu um erro no servidor::${i?.error?.message}`),t.join(", ")):(t.push(`Tamanho do video: ${this.videoWrapper.style.width} x ${this.videoWrapper.style.height}. Tamanho enviado para a API: ${this.canvasBackground.width}px x ${this.canvasBackground.height}px`),"1.33"!==(this.canvasBackground.width/this.canvasBackground.height).toFixed(2)&&t.push("A imagem não está com a proporção adequada. Tente a proporção 4/3 | Por ex.: 640x480, 800x600, 960x720 ou 1024x768"),!this.isMobile()&&this.canvasBackground.width<=320&&t.push("O tamanho da imagem está com tamanho e proporção adequados para desktop, porém não para o liveness. Tente usar na configuração inicial o config.scalingFactorForLiveness = 3"),!this.isMobile()&&this.canvasBackground.width>320&&this.canvasBackground.width<=515&&t.push("O tamanho da imagem está com tamanho e proporção adequados para desktop, porém não para o liveness. Tente usar na configuração inicial o config.scalingFactorForLiveness = 2"),!this.isMobile()&&this.canvasBackground.width>515&&this.canvasBackground.width<700&&t.push("O tamanho da imagem está com tamanho e proporção adequados para desktop, porém não para o liveness. Tente usar na configuração inicial o config.scalingFactorForLiveness = 1.5"),t.join(", "))}removeLoading(){const e=document.getElementById("spinner");e&&e.remove()}setHasNoNetwork(){document.getElementById("spinner")||this.videoWrapper.insertAdjacentHTML("beforeend",'<div id="spinner">\n        <div class="lds-ripple">\n          <div style="color: white"></div>\n          <div style="color: white"></div>\n        </div>\n        <p>Estamos sem conexão<br />com a internet</p>\n        <style>\n        #spinner {\n          top: 0;\n          z-index: 999;\n          width: 100%;\n          height: 100%;\n          display: flex;\n          position: absolute;\n          align-items: center;\n          flex-direction: column;\n          justify-content: center;\n          background: rgba(20, 20, 20, 1);\n        }\n        .lds-ripple {\n          width: 80px;\n          height: 80px;\n          position: relative;\n        }\n        .lds-ripple div {\n          position: absolute;\n          border: 4px solid #000;\n          opacity: 1;\n          border-radius: 50%;\n          border-color: white;\n          animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;\n        }\n        .lds-ripple div:nth-child(2) {\n          animation-delay: -0.5s;\n        }\n        #spinner p {\n          color: white;\n          text-align: center;\n          animation: blink 1s linear infinite;\n        }\n\n        @keyframes blink {\n          0% {\n            opacity: 1;\n          }\n          100% {\n            opacity: 0.2;\n          }\n        }\n        @keyframes lds-ripple {\n          0% {\n            top: 36px;\n            left: 36px;\n            width: 0;\n            height: 0;\n            opacity: 1;\n            color: white;\n          }\n          100% {\n            top: 0px;\n            left: 0px;\n            width: 72px;\n            height: 72px;\n            opacity: 0;\n          }\n        }\n        </style>\n      </div>')}async sendPictureByXmlRequest(){const e=`${this.livenessUrlBase}${this.livenessConfirmEndpoint}`,t=new XMLHttpRequest;t.open("POST",e,!0),t.setRequestHeader("Authorization",`Bearer ${this.token}`),t.upload.addEventListener("loadstart",(e=>{this.stop(),this.setLoadingAccessibilityProgress()})),t.upload.addEventListener("loadend",(e=>{this.removeLoadingAccessibilityProgress()})),t.upload.addEventListener("progress",(e=>{this.uploadInProgress=e.loaded/e.total*100,this.removeLoading(),this.setLoadingProgress()})),t.onreadystatechange=()=>{if(t.readyState===XMLHttpRequest.DONE){const e=JSON.parse(t?.response);switch(e?.data?.isAlive||(e.tips=this.getTips(t)),t.status){case 200:this.successCallback({...e,base64:this.base64});break;case 401:default:this.errorCallback({error:e,base64:this.base64})}this.resetLiveness()}},"b64"===this.requestType?await this.sendBase64(t):await this.sendFormData(t)}async sendBase64(e){e.setRequestHeader("Content-Type","application/json"),e.send(JSON.stringify({base64:{key:this.toB64()}}))}async sendFormData(e){const t=await this.toFormData();e.send(t)}async toFormData(){const e=new FormData,t=await fetch(this.base64),i=await t.blob();return e.append("selfie",i,"image.png"),e}toB64(){return this.base64.split(",")[1]}confirmPicture(){try{this.sendPictureByXmlRequest()}catch(e){this.errorCallback({error:e,base64:this.base64})}}}}},t={},i=function i(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,i),o.exports}(365);Liveness=i})();
//# sourceMappingURL=liveness.js.map