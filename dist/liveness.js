var Liveness;(()=>{"use strict";var e={803:e=>{e.exports=class{constructor(e,t){t.height=Math.floor(.7778*t.width),this.config=t,this.token=t.token,this.videoWrapper=e,this.faceapiPath=t.faceapiPath,this.faceapiModels=t.faceapiModels,this.isShowPreview=t.isShowPreview,this.errorCallback=t.errorCallback,this.successCallback=t.successCallback,this.livenessUrlBase=t.livenessUrlBase,this.displaySize={width:t.width,height:t.height},this.livenessConfirmEndpoint=t.livenessConfirmEndpoint||"/liveness"}async start(){await this.loadFaceApi(),await this.loadFaceApiModels(),this.setLiveness()}setLiveness(){this.setLoading(),this.createModalConfirmationWrapper().createModalConfirmation().createVideoElement().startVideo()}resetLiveness(){this.removeCanvas(),this.resetVideoWrapper(),this.closePreviewModal(),this.base64="",this.removeLoading(),this.setLiveness()}async loadFaceApi(){const e=document.createElement("script");return e.src=this.faceapiPath,document.head.append(e),this}async loadFaceApiModels(){return setTimeout((async()=>{this.faceapi=faceapi,await this.faceapi.nets.tinyFaceDetector.loadFromUri(this.faceapiModels),await this.faceapi.nets.faceLandmark68Net.loadFromUri(this.faceapiModels),await this.faceapi.nets.faceRecognitionNet.loadFromUri(this.faceapiModels),await this.faceapi.nets.faceExpressionNet.loadFromUri(this.faceapiModels)}),100),this}startVideo(){return setTimeout((()=>{navigator.mediaDevices.getUserMedia({video:{}}).then((e=>{this.video.srcObject=e})).catch((e=>console.error(e)))}),100),this}createVideoElement(){return this.video=document.createElement("video"),this.video.style.width=this.config.width,this.video.style.height=this.config.height,this.video.style.transform="scaleX(-1)",this.video.setAttribute("muted",!0),this.video.setAttribute("autoplay",!0),this.videoWrapper.style.position="relative",this.videoWrapper.style.width=this.config.width,this.videoWrapper.style.height=this.config.height,this.videoWrapper.append(this.video),this.setVideoMask(),this.video.addEventListener("play",(()=>{this.createMessageBox(),this.loop()})),this}resetVideoWrapper(){const e=document.getElementById("video-wrapper");e&&(e.innerHTML="")}removeCanvas(){const e=document.getElementsByTagName("canvas")[0];e&&e.remove()}setVideoMask(){this.videoWrapper.insertAdjacentHTML("beforeend",this.createMask()),this.maskEllipse=document.getElementById("mask-ellipse"),this.svgMask=document.getElementById("svg-mask"),this.svgMask.style.width=this.config.width,this.svgMask.style.height=this.config.height}createMask(){return'<svg\n    id="svg-mask"\n    style="display: none;"\n    viewBox="0 0 720 560"\n    fill="none"\n    xmlns="http://www.w3.org/2000/svg"\n  >\n    <path\n      id="mask-ellipse"\n      d="M457.5 250C457.5 288.479 446.435 323.21 428.671 348.256C410.904 373.308 386.589 388.5 360 388.5C333.411 388.5 309.096 373.308 291.329 348.256C273.565 323.21 262.5 288.479 262.5 250C262.5 211.521 273.565 176.79 291.329 151.744C309.096 126.692 333.411 111.5 360 111.5C386.589 111.5 410.904 126.692 428.671 151.744C446.435 176.79 457.5 211.521 457.5 250Z"\n      stroke="#B40000"\n      stroke-width="5"\n    />\n    <path\n      fill-rule="evenodd"\n      clip-rule="evenodd"\n      d="M30 10C18.9543 10 10 18.9543 10 30V533C10 544.046 18.9543 553 30 553H690C701.046 553 710 544.046 710 533V30C710 18.9543 701.046 10 690 10H30ZM360 391C415.228 391 460 327.872 460 250C460 172.128 415.228 109 360 109C304.772 109 260 172.128 260 250C260 327.872 304.772 391 360 391Z"\n      fill="#000"\n      fill-opacity="0.6"\n    />\n    <rect\n      x="12.5"\n      y="12.5"\n      width="695"\n      height="535"\n      stroke="white"\n      stroke-width="25"\n    />\n  </svg>'}loop(){const e=this.faceapi.createCanvasFromMedia(this.video);e.style.position="absolute",e.style.top=8,document.body.append(e),this.faceapi.matchDimensions(e,this.displaySize),this.svgMask.setAttribute("style","display: block; position:absolute; top: 0; left: 0;"),this.maskEllipse.setAttribute("style","display: block;");const t={width:Math.floor(this.config.width/3.6),height:Math.floor(this.config.height/2)};t.left=Math.floor(e.width/2-t.width/2),t.top=Math.floor(e.height/2-t.height/1.65);const i={width:Math.floor(.8*t.width),height:Math.floor(t.height/5)};i.left=Math.floor(t.left+t.width/2-i.width/2),i.top=Math.floor(t.top+.4*t.height);const s={width:Math.floor(.6*t.width),height:Math.floor(t.height/5)};s.left=Math.floor(t.left+t.width/2-s.width/2),s.top=Math.floor(t.top+.4*t.height);const n=e.getContext("2d");n.translate(e.width,0),n.scale(-1,1),this.config.isDebug&&this.draw(n,e,t,s,i);const o=e.getBoundingClientRect(),r={counter:0,inProgress:!1,done:!1},a=setInterval((async()=>{if(r.inProgress||r.done)return;r.inProgress=!0;const h=await this.faceapi.detectSingleFace(this.video,new this.faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceExpressions();if(this.removeLoading(),!h)return this.blockMask("Face não encontrada",o,t.left,t.top,t.height,t.width),r.counter=0,void(r.inProgress=!1);const d=this.faceapi.resizeResults(h,this.displaySize);if(d&&d.expressions){const e=this.getExpression(d.expressions);if("neutral"!==e)return this.config.isDebug?this.blockMask(`Mantenha expressão neutra >> ${e}`,o,t.left,t.top,t.height,t.width):this.blockMask("Mantenha expressão neutra",o,t.left,t.top,t.height,t.width),r.counter=0,void(r.inProgress=!1)}if(d.detection){const h=this.getPose(d);if("front"!==h)return this.config.isDebug?this.blockMask(`Centralize seu rosto >> ${h}`,o,t.left,t.top,t.height,t.width):this.blockMask("Centralize seu rosto",o,t.left,t.top,t.height,t.width),r.counter=0,void(r.inProgress=!1);const l=d.landmarks.getJawOutline();if(this.isRotatedFace(l[0],l[16]))return this.config.isDebug?this.blockMask("Centralize seu rosto >> rotacionado",o,t.left,t.top,t.height,t.width):this.blockMask("Centralize seu rosto",o,t.left,t.top,t.height,t.width),r.counter=0,void(r.inProgress=!1);this.config.isDebug&&(this.draw(n,e,t,s,i),n.beginPath(),n.lineWidth="5",n.strokeStyle="green",n.moveTo(l[0].x,l[0].y),n.lineTo(l[16].x,l[16].y),n.stroke());const c={meanPosition:[l[0].x,l[0].y],frameBox:{isInside:!1},outterBox:{isInside:!1},innerBox:{isInside:!1}},p={meanPosition:[l[16].x,l[16].y],frameBox:{isInside:!1},outterBox:{isInside:!1},innerBox:{isInside:!1}};if(c.frameBox.isInside=this.isInside(c.meanPosition,{top:t.top,left:t.left,width:t.width,height:t.height}),p.frameBox.isInside=this.isInside(p.meanPosition,{top:t.top,left:t.left,width:t.width,height:t.height}),c.outterBox.isInside=this.isInside(c.meanPosition,{top:i.top,left:i.left,width:i.width,height:i.height}),p.outterBox.isInside=this.isInside(p.meanPosition,{top:i.top,left:i.left,width:i.width,height:i.height}),c.innerBox.isInside=this.isInside(c.meanPosition,{top:s.top,left:s.left,width:s.width,height:s.height}),p.innerBox.isInside=this.isInside(p.meanPosition,{top:s.top,left:s.left,width:s.width,height:s.height}),!c.frameBox.isInside||!p.frameBox.isInside)return this.blockMask("Posicione seu rosto dentro da moldura",o,t.left,t.top,t.height,t.width),r.counter=0,void(r.inProgress=!1);if(!c.outterBox.isInside||!p.outterBox.isInside)return this.blockMask("Afaste seu rosto",o,t.left,t.top,t.height,t.width),r.counter=0,void(r.inProgress=!1);if(c.innerBox.isInside||p.innerBox.isInside)return this.blockMask("Aproxime seu rosto",o,t.left,t.top,t.height,t.width),r.counter=0,void(r.inProgress=!1);this.msg.style="display: none;",this.activateEllipseMask(),r.counter+=1,r.inProgress=!1,r.counter>=2&&(r.done=!0,this.takePicture(e),clearInterval(a))}}),250)}activateEllipseMask(){this.maskEllipse.setAttribute("stroke","#0F0")}deactivateEllipseMask(){this.maskEllipse.setAttribute("stroke","#F00")}draw(e,t,i,s,n){e.clearRect(0,0,t.width,t.height),e.beginPath(),e.lineWidth="3",e.strokeStyle="blue",e.rect(i.left,i.top,i.width,i.height),e.stroke(),e.beginPath(),e.lineWidth="2",e.strokeStyle="blue",e.rect(s.left,s.top,s.width,s.height),e.stroke(),e.beginPath(),e.lineWidth="2",e.strokeStyle="red",e.rect(n.left,n.top,n.width,n.height),e.stroke()}getExpression(e){const t=[];for(const[i,s]of Object.entries(e))t.push({expression:i,confidence:s});const i=t.sort(((e,t)=>e.confidence-t.confidence)).pop();return i&&i.expression?i.expression:null}getPose(e){const t=this.getMeanPosition(e.landmarks.getRightEye()),i=this.getMeanPosition(e.landmarks.getLeftEye()),s=this.getMeanPosition(e.landmarks.getNose()),n=this.getMeanPosition(e.landmarks.getMouth()),o=(this.getTop(e.landmarks.getJawOutline())-n[1])/e.detection.box.height+.5,r=(i[0]+(t[0]-i[0])/2-s[0])/e.detection.box.width;let a="undetected";return e.detection.score>.3&&(a="front",o>.2?a="top":o<-.1?a="bottom":(r<-.04&&(a="left"),r>.04&&(a="right"))),a}isRotatedFace(e,t){return Math.abs(180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI)>7}getMeanPosition(e){return e.map((e=>[e.x,e.y])).reduce(((e,t)=>[e[0]+t[0],e[1]+t[1]])).map((t=>t/e.length))}getTop(e){return e.map((e=>e.y)).reduce(((e,t)=>Math.min(e,t)))}isInside(e=[],t={}){return!(e[1]<t.top||e[0]<t.left||e[1]>t.top+t.height||e[0]>t.left+t.width)}blockMask(e,t,i,s,n,o){const r={width:230,height:35};r.top=s+n+20,r.left=i+o/2-r.width/2,this.maskEllipse.setAttribute("stroke","#B40000"),this.msg.textContent=e,this.msg.style=`\n      padding: 10px;\n      color: #ba3939;\n      position: absolute;\n      text-align: center;\n      background: #ffe0e0;\n      top: ${r.top}px;\n      left: ${r.left}px;\n      width: ${r.width}px; \n      height: ${r.height}px;\n      border: 1px solid #a33a3a;\n      font-family: 'Prompt', sans-serif;\n    `}takePicture(e){const t=e.getContext("2d");e.style="display: none;",t.drawImage(this.video,0,0,e.width,e.height),this.base64=e.toDataURL("image/png"),this.isShowPreview?this.openPreviewModal():this.confirmPicture()}createMessageBox(){return this.msg=document.createElement("div"),this.videoWrapper.append(this.msg),this}createModalConfirmationWrapper(){return this.modalWrapper=document.createElement("div"),this.modalWrapper.style="\n    top: 0;\n    left: 0;\n    z-index: 10;\n    width: 100%;\n    height: 100%;\n    display: none;\n    position: fixed;\n    align-items: center;\n    justify-content: center;\n    background: rgba(20, 20, 20, 0.95);\n    ",this.modalWrapper.id="modalWrapper",document.body.append(this.modalWrapper),this}createModalConfirmation(){this.modalConfirmation=document.createElement("div"),this.modalConfirmation.style="\n    padding: 7px;\n    display: flex;\n    max-width: 720px;\n    background: white;\n    max-height: 560px;\n    border-radius: 7px;\n    position: relative;\n    align-items: center;\n    justify-content: center;\n    ";const e=document.createElement("button");e.textContent="Confirmar",e.style="\n    color: #555;\n    right: 10px;\n    width: 160px;\n    height: 50px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const t=document.createElement("button");t.textContent="Cancelar",t.style="\n    color: #444;\n    right: 10px;\n    width: 160px;\n    height: 50px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const i=document.createElement("div");return i.style="\n    right: 0;\n    bottom: 0;\n    width: 100%;\n    display: flex;\n    padding: 10px 0;\n    position: absolute;\n    justify-content: center;\n    ",i.append(t),i.append(e),this.modalConfirmation.append(i),this.modalWrapper.append(this.modalConfirmation),e.addEventListener("click",(()=>{this.closePreviewModal(),this.confirmPicture()})),t.addEventListener("click",(()=>{this.cancelPicture()})),this}openPreviewModal(){const e=document.createElement("img");e.src=this.base64,e.style="\n      max-width: 720px;\n      min-width: 520px;\n      min-height: 360px;\n      max-height: 560px;\n      object-fit: cover;\n      border-radius: 7px;\n    ",this.modalConfirmation.append(e),this.modalWrapper.style.display="flex"}closePreviewModal(){const e=document.getElementById("modalWrapper");e&&e.remove()}cancelPicture(){this.resetLiveness()}setLoading(){this.videoWrapper.insertAdjacentHTML("beforeend",'<div id="spinner">\n        <div class="lds-ripple">\n          <div style="color: white"></div>\n          <div style="color: white"></div>\n        </div>\n        <style>\n        #spinner {\n          z-index: 40;\n          align-content: center;\n          width: 100%;\n          height: 100%;\n          display: flex;\n          position: absolute;\n          align-items: center;\n          justify-content: center;\n          background: rgba(20, 20, 20, 1);\n          top: 0;\n        }\n        .lds-ripple {\n          width: 80px;\n          height: 80px;\n          position: relative;\n        }\n        .lds-ripple div {\n          position: absolute;\n          border: 4px solid #000;\n          opacity: 1;\n          border-radius: 50%;\n          border-color: white;\n          animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;\n        }\n        .lds-ripple div:nth-child(2) {\n          animation-delay: -0.5s;\n        }\n        @keyframes lds-ripple {\n          0% {\n            top: 36px;\n            left: 36px;\n            width: 0;\n            height: 0;\n            opacity: 1;\n            color: white;\n          }\n          100% {\n            top: 0px;\n            left: 0px;\n            width: 72px;\n            height: 72px;\n            opacity: 0;\n          }\n        }\n        </style>\n      </div>')}removeLoading(){const e=document.getElementById("spinner");e&&e.remove()}confirmPicture(){const e={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({base64:{key:this.base64.replace("data:image/png;base64,","")}})};this.setLoading();const t=`${this.livenessUrlBase}${this.livenessConfirmEndpoint}`;fetch(t,e).then((e=>e.json())).then((e=>{if(e&&e.error&&401===e.error.statusCode)return alert("Token inválido"),this.resetLiveness(),void this.errorCallback(e);let t=!1;e&&e.data&&e.data.real&&parseFloat(e.data.real)>.97&&(t=!0),e&&e.isAlive&&(t=!0),t?this.successCallback(e):this.errorCallback(e)})).catch((e=>{console.log("error",e),this.errorCallback(e)})).finally((()=>{this.resetLiveness(),this.removeLoading()}))}}}},t={},i=function i(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,i),o.exports}(803);Liveness=i})();
//# sourceMappingURL=liveness.js.map