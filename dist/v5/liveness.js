var Liveness;(()=>{"use strict";var t={708:t=>{t.exports=class{constructor(t,e){const i=window.innerWidth;e.width>=i&&(e.width=i-20),e.height=Math.floor(.7778*e.width),this.config=e,this.token=e.token,this.videoWrapper=t,this.faceapi=null;const n=document.createElement("style");n.innerText=this.cssOrientationLock(),document.head.appendChild(n),e.brightnessControl?this.brightnessControl=e.brightnessControl:this.brightnessControl=108,e.luminanceControl?this.luminanceControl=e.luminanceControl:this.luminanceControl=23,this.faceapiPath=e.faceapiPath,this.isShowPreview=e.isShowPreview,this.errorCallback=e.errorCallback,this.successCallback=e.successCallback,this.livenessUrlBase=e.livenessUrlBase,this.displaySize={width:e.width,height:e.height},this.livenessConfirmEndpoint=e.livenessConfirmEndpoint||"/liveness/v2"}setMinBrightness(t){this.brightnessControl=t}setMinLuminance(t){this.luminanceControl=t}async start(){window.faceapi?(this.faceapi=window.faceapi,this.setLiveness()):await this.loadFaceApi()}setLiveness(){this.setLoading(),this.createModalConfirmationWrapper().createModalConfirmation().createVideoElement().startVideo().createCanvasBackground()}resetLiveness(){this.removeCanvas(),this.resetVideoWrapper(),this.closePreviewModal(),this.base64="",this.removeLoading(),this.setLiveness()}cssOrientationLock(){return"@media screen and (min-width: 320px) and (max-width: 767px) and (orientation: landscape) { html { transform: rotate(-90deg);transform-origin: left top;width: 100vh;overflow-x: hidden;position: absolute;top: 100%;left: 0;}}"}createCanvasBackground(){this.canvasBackground=document.createElement("canvas"),this.canvasBackground.width=720,this.canvasBackground.height=560,this.canvasBackground.style.display="none"}sweepVideo(t){this.luminanceAvg=0,this.brightnessSum=0,this.luminanceArray=[];for(let e=0;e<t.length;e+=4){const i=t[e],n=t[e+1],s=t[e+2];this.sweepBrightness(i,n,s),this.sweepLuminance(i,n,s)}this.checkBrightness()}checkBrightness(){this.brightness=Math.floor(this.brightnessSum/(this.canvasBackground.width*this.canvasBackground.height))}sweepBrightness(t,e,i){this.brightnessSum+=Math.floor((t+e+i)/3)}sweepLuminance(t,e,i){this.luminanceAvg+=this.calcLuminance(t,e,i),this.luminanceArray.push(this.calcLuminance(t,e,i)),this.luminance=this.luminanceAvg/this.luminanceArray?.length*100}calcLuminance(t,e,i){let n,s=[t,e,i];for(let t=0;t<s.length;t++)n=s[t]/255,n<=.03928?n/=12.92:n=Math.pow((n+.055)/1.055,2.4),s[t]=n;return.2126*s[0]+.7152*s[1]+.0722*s[2]+.05}async loadFaceApi(){const t=document.createElement("script"),e=`${this.faceapiPath}/face-api.min.js`;return t.src=e,document.head.append(t),t.onload=async()=>{await this.loadFaceApiModels()},this}async loadFaceApiModels(){return setTimeout((async()=>{Promise.all([window.faceapi.nets.tinyFaceDetector.loadFromUri(this.faceapiPath),window.faceapi.nets.faceLandmark68Net.loadFromUri(this.faceapiPath),window.faceapi.nets.faceRecognitionNet.loadFromUri(this.faceapiPath),window.faceapi.nets.faceExpressionNet.loadFromUri(this.faceapiPath)]).then((()=>{console.log("Models are loaded"),this.faceapi=faceapi,this.setLiveness()})).catch((t=>console.log(t)))}),100),this}startVideo(){return void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(t){const e=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return e?new Promise((function(i,n){e.call(navigator,t,i,n)})):Promise.reject(new Error("getUserMedia não implementado nesse browser"))}),navigator.mediaDevices.getUserMedia({video:{width:this.config.width,height:this.config.height}}).then((t=>{const e=document.querySelector("video");"srcObject"in e?e.srcObject=t:e.src=window.URL.createObjectURL(t)})).catch((t=>console.error(t))),this}createVideoElement(){return this.video=document.createElement("video"),this.video.style.width=this.config.width,this.video.style.height=this.config.height,this.video.style.transform="scaleX(-1)",this.video.setAttribute("muted",!0),this.video.setAttribute("autoplay",!0),this.videoWrapper.style.position="relative",this.videoWrapper.style.width=this.config.width,this.videoWrapper.style.height=this.config.height,this.videoWrapper.append(this.video),this.setVideoMask(),this.video.addEventListener("play",(()=>{this.createMessageBox(),this.loop()})),this}resetVideoWrapper(){const t=document.getElementById("video-wrapper");t&&(t.innerHTML="")}removeCanvas(){const t=document.getElementsByTagName("canvas")[0];t&&t.remove()}setVideoMask(){this.videoWrapper.insertAdjacentHTML("beforeend",this.createMask()),this.maskEllipse=document.getElementById("mask-ellipse"),this.svgMask=document.getElementById("svg-mask"),this.svgMask.style.width=this.config.width,this.svgMask.style.height=this.config.height}createMask(){return'<svg\n    id="svg-mask"\n    style="display: none;"\n    fill="none"\n    xmlns="http://www.w3.org/2000/svg"\n    viewBox="0 0 720 560"\n  >\n    <path\n      id="mask-ellipse"\n      d="M507.5 275C507.5 332.25 490.842 383.977 464.035 421.328C437.225 458.683 400.41 481.5 360 481.5C319.59 481.5 282.775 458.683 255.965 421.328C229.158 383.977 212.5 332.25 212.5 275C212.5 217.75 229.158 166.023 255.965 128.672C282.775 91.3174 319.59 68.5 360 68.5C400.41 68.5 437.225 91.3174 464.035 128.672C490.842 166.023 507.5 217.75 507.5 275Z"\n      stroke="#B40000"\n      stroke-width="5"\n    />\n    <path\n      fill-rule="evenodd"\n      clip-rule="evenodd"\n      d="M21 10C15.4772 10 11 14.4772 11 20V542C11 547.523 15.4771 552 21 552H698C703.523 552 708 547.523 708 542V20C708 14.4772 703.523 10 698 10H21ZM360 481C441.186 481 507 388.771 507 275C507 161.229 441.186 69 360 69C278.814 69 213 161.229 213 275C213 388.771 278.814 481 360 481Z"\n      fill="#000"\n      fill-opacity="0.6"\n    />\n    <rect\n      x="12.5"\n      y="12.5"\n      width="695"\n      height="535"\n      stroke="white"\n      stroke-width="25"\n    />\n  </svg>'}loop(){this.video.style.width.includes("%")&&(this.displaySize.width=this.video.style.width=this.video.clientWidth),this.canvas=this.faceapi.createCanvasFromMedia(this.video),this.canvas.style.position="absolute",this.canvas.style.left=0,this.canvas.style.top=8,this.canvas.style.width=this.videoWrapper.style.width,this.canvas.style.height=this.videoWrapper.style.height,this.videoWrapper.append(this.canvas),this.faceapi.matchDimensions(this.canvas,this.displaySize),this.svgMask.setAttribute("style","display: block; position:absolute; top: 0; left: 0;"),this.maskEllipse.setAttribute("style","display: block;");const t={width:Math.floor(.515*this.config.width),height:Math.floor(.922*this.config.height)};t.left=Math.floor(this.canvas.width/2-t.width/2),t.top=Math.floor((this.canvas.height-t.height)/2.25);const e={width:Math.floor(.8*t.width),height:Math.floor(t.height/5)};e.left=Math.floor(t.left+t.width/1.95-e.width/1.95),e.top=Math.floor(t.top+.3*t.height);const i={width:Math.floor(.68*t.width),height:Math.floor(t.height/5)};i.left=Math.floor(t.left+t.width/1.96-i.width/1.96),i.top=Math.floor(t.top+.3*t.height);const n=this.canvas.getContext("2d");n.translate(this.canvas.width,0),n.scale(-1,1),this.config.isDebug&&this.draw(n,this.canvas,t,i,e);const s=this.canvas.getBoundingClientRect(),o={counter:0,inProgress:!1,done:!1},a=setInterval((()=>{this.checkBackground()}),1e3),r=setInterval((async()=>{if(o.inProgress||o.done)return;o.inProgress=!0;const h=await this.faceapi.detectSingleFace(this.video,new this.faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceExpressions();if(this.removeLoading(),!h)return this.blockMask("Face não encontrada",s,t.left,t.top,t.height,t.width),o.counter=0,void(o.inProgress=!1);const d=this.faceapi.resizeResults(h,this.displaySize);if(d&&d.expressions){const e=this.getExpression(d.expressions);if("neutral"!==e)return this.config.isDebug?this.blockMask(`Mantenha expressão neutra >> ${e}`,s,t.left,t.top,t.height,t.width):this.blockMask("Mantenha expressão neutra",s,t.left,t.top,t.height,t.width),o.counter=0,void(o.inProgress=!1)}if(d.detection){const h=this.getPose(d);if("front"!==h)return this.config.isDebug?this.blockMask(`Centralize seu rosto >> ${h}`,s,t.left,t.top,t.height,t.width):this.blockMask("Centralize seu rosto",s,t.left,t.top,t.height,t.width),o.counter=0,void(o.inProgress=!1);const c=d.landmarks.getJawOutline();if(this.isRotatedFace(c[0],c[16]))return this.config.isDebug?this.blockMask("Centralize seu rosto >> rotacionado",s,t.left,t.top,t.height,t.width):this.blockMask("Centralize seu rosto",s,t.left,t.top,t.height,t.width),o.counter=0,void(o.inProgress=!1);this.config.isDebug&&(this.draw(n,this.canvas,t,i,e),n.beginPath(),n.lineWidth="5",n.strokeStyle="green",n.moveTo(c[0].x,c[0].y),n.lineTo(c[16].x,c[16].y),n.stroke());const l={meanPosition:[c[0].x,c[0].y],frameBox:{isInside:!1},outterBox:{isInside:!1},innerBox:{isInside:!1}},p={meanPosition:[c[16].x,c[16].y],frameBox:{isInside:!1},outterBox:{isInside:!1},innerBox:{isInside:!1}};if(l.frameBox.isInside=this.isInside(l.meanPosition,{top:t.top,left:t.left,width:t.width,height:t.height}),p.frameBox.isInside=this.isInside(p.meanPosition,{top:t.top,left:t.left,width:t.width,height:t.height}),l.outterBox.isInside=this.isInside(l.meanPosition,{top:e.top,left:e.left,width:e.width,height:e.height}),p.outterBox.isInside=this.isInside(p.meanPosition,{top:e.top,left:e.left,width:e.width,height:e.height}),l.innerBox.isInside=this.isInside(l.meanPosition,{top:i.top,left:i.left,width:i.width,height:i.height}),p.innerBox.isInside=this.isInside(p.meanPosition,{top:i.top,left:i.left,width:i.width,height:i.height}),!this.isBackgroundOK)return this.blockMask("O ambiente está escuro",s,t.left,t.top,t.height,t.width),o.counter=0,void(o.inProgress=!1);if(!l.frameBox.isInside||!p.frameBox.isInside)return this.blockMask("Posicione seu rosto dentro da moldura",s,t.left,t.top,t.height,t.width),o.counter=0,void(o.inProgress=!1);if(!l.outterBox.isInside||!p.outterBox.isInside)return this.blockMask("Afaste seu rosto",s,t.left,t.top,t.height,t.width),o.counter=0,void(o.inProgress=!1);if(l.innerBox.isInside||p.innerBox.isInside)return this.blockMask("Aproxime seu rosto",s,t.left,t.top,t.height,t.width),o.counter=0,void(o.inProgress=!1);this.msg.style="display: none;",this.activateEllipseMask(),o.counter+=1,o.inProgress=!1,o.counter>=2&&(o.done=!0,this.takePicture(this.canvas),clearInterval(r),clearInterval(a))}}),250)}activateEllipseMask(){this.maskEllipse.setAttribute("stroke","#0F0")}deactivateEllipseMask(){this.maskEllipse.setAttribute("stroke","#F00")}draw(t,e,i,n,s){t.clearRect(0,0,e.width,e.height),t.beginPath(),t.lineWidth="3",t.strokeStyle="blue",t.rect(i.left,i.top,i.width,i.height),t.stroke(),t.beginPath(),t.lineWidth="2",t.strokeStyle="yellow",t.rect(n.left,n.top,n.width,n.height),t.stroke(),t.beginPath(),t.lineWidth="2",t.strokeStyle="red",t.rect(s.left,s.top,s.width,s.height),t.stroke()}getExpression(t){const e=[];for(const[i,n]of Object.entries(t))e.push({expression:i,confidence:n});const i=e.sort(((t,e)=>t.confidence-e.confidence)).pop();return i&&i.expression?i.expression:null}getPose(t){const e=this.getMeanPosition(t.landmarks.getRightEye()),i=this.getMeanPosition(t.landmarks.getLeftEye()),n=this.getMeanPosition(t.landmarks.getNose()),s=this.getMeanPosition(t.landmarks.getMouth()),o=(this.getTop(t.landmarks.getJawOutline())-s[1])/t.detection.box.height+.45,a=(i[0]+(e[0]-i[0])/2-n[0])/t.detection.box.width;let r="undetected";return t.detection.score>.3&&(r="front",o>.2?r="top":o<-.1?r="bottom":(a<-.04&&(r="left"),a>.04&&(r="right"))),r}isRotatedFace(t,e){return Math.abs(180*Math.atan2(e.y-t.y,e.x-t.x)/Math.PI)>7}getMeanPosition(t){return t.map((t=>[t.x,t.y])).reduce(((t,e)=>[t[0]+e[0],t[1]+e[1]])).map((e=>e/t.length))}getTop(t){return t.map((t=>t.y)).reduce(((t,e)=>Math.min(t,e)))}isInside(t=[],e={}){return!(t[1]<e.top||t[0]<e.left||t[1]>e.top+e.height||t[0]>e.left+e.width)}blockMask(t,e,i,n,s,o){const a={width:230,height:35};a.top=n+s+20,a.left=i+o/2-a.width/2,this.maskEllipse.setAttribute("stroke","#B40000"),this.msg.textContent=t,this.msg.style=`\n      left: 50%;\n      display: flex;\n      color: #f3f3f5;\n      font-size: 1.1rem;\n      padding: 10px 20px;\n      position: absolute;\n      text-align: center;\n      align-items: center;\n      background: #D02780;\n      border-radius: 7px;\n      justify-content: center;\n      top: ${a.top}px;\n      transform: translateX(-50%);\n      width: ${a.width}px;\n      height: ${a.height}px;\n      font-family: Prompt, sans-serif;\n    `}takePicture(t){const e=this.canvasBackground.getContext("2d");this.canvasBackground.style.display="none;",e.drawImage(this.video,0,0,this.canvasBackground.width,this.canvasBackground.height),this.base64=this.canvasBackground.toDataURL("image/png"),this.isShowPreview?this.openPreviewModal():this.confirmPicture()}checkBackground(){if(!this.canvasBackground)return;const t=this.canvasBackground.getContext("2d");t.drawImage(this.video,0,0,this.canvasBackground.width,this.canvasBackground.height);const e=t.getImageData(0,0,this.canvasBackground.width,this.canvasBackground.height);if(this.sweepVideo(e.data),this.isBackgroundOK=this.brightness>=this.brightnessControl&&this.luminance>=this.luminanceControl,this.config.isDebug){const t={brilho:{atual:this.brightness,"mín aceitável":this.brightnessControl},luminânia:{atual:parseFloat(this.luminance.toFixed(2)),"mín aceitável":this.luminanceControl}};console.table(t)}}createMessageBox(){return this.msg=document.createElement("div"),this.videoWrapper.append(this.msg),this}createModalConfirmationWrapper(){return this.modalWrapper=document.createElement("div"),this.modalWrapper.style="\n    top: 0;\n    left: 0;\n    z-index: 10;\n    width: 100%;\n    height: 100%;\n    display: none;\n    position: fixed;\n    align-items: center;\n    justify-content: center;\n    background: rgba(20, 20, 20, 0.95);\n    ",this.modalWrapper.id="modalWrapper",document.body.append(this.modalWrapper),this}createModalConfirmation(){this.modalConfirmation=document.createElement("div"),this.modalConfirmation.style="\n    padding: 7px;\n    display: flex;\n    max-width: 720px;\n    background: white;\n    max-height: 560px;\n    border-radius: 7px;\n    position: relative;\n    align-items: center;\n    justify-content: center;\n    ";const t=document.createElement("button");t.textContent="Confirmar",t.style="\n    color: #555;\n    right: 10px;\n    width: 160px;\n    height: 50px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const e=document.createElement("button");e.textContent="Cancelar",e.style="\n    color: #444;\n    right: 10px;\n    width: 160px;\n    height: 50px;\n    bottom: 10px;\n    cursor: pointer;\n    background: #fff;\n    font-weight: 600;\n    border-radius: 7px;\n    margin-right: 10px;\n    border: 1px solid #222;\n    ";const i=document.createElement("div");return i.style="\n    right: 0;\n    bottom: 0;\n    width: 100%;\n    display: flex;\n    padding: 10px 0;\n    position: absolute;\n    justify-content: center;\n    ",i.append(e),i.append(t),this.modalConfirmation.append(i),this.modalWrapper.append(this.modalConfirmation),t.addEventListener("click",(()=>{this.closePreviewModal(),this.confirmPicture()})),e.addEventListener("click",(()=>{this.cancelPicture()})),this}openPreviewModal(){const t=document.createElement("img");t.src=this.base64,t.style="\n      max-width: 720px;\n      min-width: 520px;\n      min-height: 360px;\n      max-height: 560px;\n      object-fit: cover;\n      border-radius: 7px;\n    ",this.modalConfirmation.append(t),this.modalWrapper.style.display="flex"}closePreviewModal(){const t=document.getElementById("modalWrapper");t&&t.remove()}cancelPicture(){this.resetLiveness()}setLoading(){this.videoWrapper.insertAdjacentHTML("beforeend",'<div id="spinner">\n        <div class="lds-ripple">\n          <div style="color: white"></div>\n          <div style="color: white"></div>\n        </div>\n        <style>\n        #spinner {\n          z-index: 40;\n          align-content: center;\n          width: 100%;\n          height: 100%;\n          display: flex;\n          position: absolute;\n          align-items: center;\n          justify-content: center;\n          background: rgba(20, 20, 20, 1);\n          top: 0;\n        }\n        .lds-ripple {\n          width: 80px;\n          height: 80px;\n          position: relative;\n        }\n        .lds-ripple div {\n          position: absolute;\n          border: 4px solid #000;\n          opacity: 1;\n          border-radius: 50%;\n          border-color: white;\n          animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;\n        }\n        .lds-ripple div:nth-child(2) {\n          animation-delay: -0.5s;\n        }\n        @keyframes lds-ripple {\n          0% {\n            top: 36px;\n            left: 36px;\n            width: 0;\n            height: 0;\n            opacity: 1;\n            color: white;\n          }\n          100% {\n            top: 0px;\n            left: 0px;\n            width: 72px;\n            height: 72px;\n            opacity: 0;\n          }\n        }\n        </style>\n      </div>')}removeLoading(){const t=document.getElementById("spinner");t&&t.remove()}confirmPicture(){const t={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({base64:{key:this.base64.replace("data:image/png;base64,","")}})};this.setLoading();const e=`${this.livenessUrlBase}${this.livenessConfirmEndpoint}`;fetch(e,t).then((t=>t.json())).then((t=>{t?.data?this.successCallback({...t,base64:this.base64}):401!==t?.error?.statusCode?(this.errorCallback({error:t?.error,base64:this.base64}),console.error("error:",t?.error?.message)):alert("Token inválido")})).catch((t=>{t.base64=this.base64,this.errorCallback(t)})).finally((()=>{this.resetLiveness(),this.removeLoading()}))}}}},e={},i=function i(n){var s=e[n];if(void 0!==s)return s.exports;var o=e[n]={exports:{}};return t[n](o,o.exports,i),o.exports}(708);Liveness=i})();
//# sourceMappingURL=liveness.js.map